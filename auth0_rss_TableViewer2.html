<!DOCTYPE html>
<html lang="ja">
<head>
  <!--
  Auth0 RSS ビューア – サニタイザ強化・バッジ非表示・Lightbox修正（未定義関数エラー解消）
  Last-Updated: 2025-10-02 11:46:16Z (UTC)
-->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Auth0 RSS ビューア（ローカルXML対応 / CSV・HTMLエクスポート付）</title>
  <style>
    :root{
      --bg:#f7f9fc; --card:#ffffff; --txt:#1e293b; --muted:#5b677a; --accent:#0b6bcb; --border:#d7e0ea;
      --danger:#d62323; --ok:#17803d; --blocked:#b36b00; --hl:#fff1a6;
      --row:#ffffff; --rowAlt:#f2f6fb; --hover:#eef3fb; --link:#0b6bcb;
    }
    body.theme-light{ --bg:#f7f9fc; --card:#ffffff; --txt:#1e293b; --muted:#5b677a; --accent:#0b6bcb; --border:#d7e0ea; --danger:#d62323; --ok:#17803d; --blocked:#b36b00; --hl:#fff1a6; --row:#ffffff; --rowAlt:#f2f6fb; --hover:#eef3fb; --link:#0b6bcb; }
    body.theme-dark{ --bg:#0b0c10; --card:#12151a; --txt:#e6e6e6; --muted:#a8b0bd; --accent:#3aa0ff; --border:#263141; --danger:#ff6464; --ok:#2ecc71; --blocked:#ffb74d; --hl:#ffe08a; --row:#12151a; --rowAlt:#0f141f; --hover:#121826; --link:#6bb8ff; }
    @media (prefers-color-scheme: dark){ body.theme-auto{ --bg:#0b0c10; --card:#12151a; --txt:#e6e6e6; --muted:#a8b0bd; --accent:#3aa0ff; --border:#263141; --danger:#ff6464; --ok:#2ecc71; --blocked:#ffb74d; --hl:#ffe08a; --row:#12151a; --rowAlt:#0f141f; --hover:#121826; --link:#6bb8ff; } }

    html,body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif}
    a{color:var(--link)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg),rgba(0,0,0,.02));backdrop-filter:blur(4px);}
    .wrap{max-width:min(1800px,98vw);margin:0 auto;padding:12px 16px}
    h1{margin:.2rem 0 .4rem 0;font-size:1.1rem;color:var(--muted);font-weight:600}
    .hdrbar{position:relative;display:flex;align-items:center;gap:8px;min-height:40px}
    .hdrbar h1{padding-right:180px}
    .collapse-btn{position:absolute;right:0;top:0;appearance:none;border:1px solid var(--border);background:color-mix(in oklab, var(--card), var(--bg));color:var(--txt);padding:6px 10px;border-radius:8px;cursor:pointer;font-size:.9rem}
    .collapse-btn:hover{border-color:color-mix(in oklab, var(--border), var(--accent) 45%);background:color-mix(in oklab, var(--card), var(--accent) 8%)}
    .collapse-btn .ico{margin-right:.35em}

    .controls{display:grid;grid-template-columns:1fr;gap:12px;margin-top:8px}
    @media(min-width:1200px){.controls{grid-template-columns:1.2fr 1.2fr 1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px}

    header.collapsed h1{display:none}
    header.collapsed .controls{display:none}
    header.collapsed .wrap{padding:8px 16px}

    label{font-size:.9rem;color:var(--muted)}
    input[type="file"],input[type="text"],input[type="date"],textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:color-mix(in oklab, var(--card), var(--bg) 10%);color:var(--txt)}
    textarea{min-height:68px;resize:vertical}
    input[type="checkbox"]{transform:scale(1.1);margin-right:6px}
    .hint{font-size:.85rem;color:var(--muted)}
    .stats{margin-top:6px;font-size:.9rem;color:var(--muted)}

    table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
    thead th{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);text-align:left;padding:10px;font-size:.9rem;color:var(--muted)}
    tbody td{vertical-align:top;border-bottom:1px solid var(--border);padding:12px 10px;background:var(--row)}
    tbody tr:nth-child(odd) td{background:var(--rowAlt)}
    tbody tr:hover td{background:var(--hover)}

    col.c-title{width:16%}
    col.c-date{width:9%}
    col.c-desc{width:65%}
    col.c-link{width:10%}

    .col-title{min-width:220px}
    .col-date{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .desc{white-space:pre-wrap;word-wrap:break-word;overflow-wrap:anywhere}
    .desc img{max-width:100%;height:auto;border-radius:6px;border:1px solid var(--border);cursor:zoom-in}
    .badge{display:none !important}
    .warn{color:var(--danger)}
    .ok{color:var(--ok)}
    .blocked{display:inline-block;padding:2px 6px;border-radius:6px;background:color-mix(in oklab, var(--blocked), var(--bg) 85%);border:1px dashed color-mix(in oklab, var(--blocked), #000 50%);color:color-mix(in oklab, var(--blocked), #000 35%);font-size:.8rem}
    .footer{color:var(--muted);font-size:.85rem;margin:20px 0}

    .btnrow{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .btn{appearance:none;border:1px solid var(--border);background:color-mix(in oklab, var(--card), var(--bg));color:var(--txt);padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn:hover{border-color:color-mix(in oklab, var(--border), var(--accent) 45%);background:color-mix(in oklab, var(--card), var(--accent) 8%)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:color-mix(in oklab, var(--card), var(--bg) 5%);color:var(--txt)}

    .row{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
    @media(min-width:520px){.row.cols-2{grid-template-columns:1fr 1fr}}
    .inline-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

    mark.h{background:var(--hl);color:#222;padding:0 .15em;border-radius:3px}

    .kebab-wrap{position:relative;display:inline-block;margin-left:6px}
    .kebab-btn{appearance:none;border:1px solid var(--border);background:color-mix(in oklab, var(--card), var(--bg));color:var(--txt);border-radius:6px;cursor:pointer;padding:2px 8px;line-height:1}
    .kebab-btn:hover{background:color-mix(in oklab, var(--card), var(--accent) 8%);border-color:color-mix(in oklab, var(--border), var(--accent) 45%)}
    .kebab-btn[aria-expanded="true"]{background:color-mix(in oklab, var(--card), var(--accent) 14%)}
    .menu{position:absolute;right:0;top:120%;min-width:180px;background:color-mix(in oklab, var(--card), var(--bg) 6%);border:1px solid color-mix(in oklab, var(--border), #000 10%);border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:6px;display:none;z-index:5}
    .menu.open{display:block}
    .menu .mi{display:flex;gap:8px;align-items:center;width:100%;padding:8px 10px;background:transparent;border:none;color:var(--txt);border-radius:6px;text-align:left;cursor:pointer}
    .menu .mi:hover{background:color-mix(in oklab, var(--card), var(--accent) 8%)}
    .menu .mi .ico{font-size:1rem;opacity:.9}

    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:999}
    .lightbox.open{display:flex}
    .lb-inner{position:relative;max-width:95vw;max-height:95vh}
    .lb-img{max-width:95vw;max-height:95vh;display:block;border-radius:8px;box-shadow:0 8px 40px rgba(0,0,0,.3)}
    .lb-close{position:absolute;top:-42px;right:0;background:#222a;backdrop-filter:blur(3px);border:1px solid #444;color:#fff;border-radius:6px;padding:6px 10px;cursor:pointer}
    .lb-nav{position:absolute;top:50%;transform:translateY(-50%);display:flex;justify-content:space-between;align-items:center;width:100%}
    .lb-btn{background:#222a;border:1px solid #444;color:#fff;border-radius:999px;width:40px;height:40px;display:grid;place-items:center;cursor:pointer}
    .lb-prev{position:absolute;left:-52px}
    .lb-next{position:absolute;right:-52px}
    @media(max-width:720px){.lb-prev{left:4px}.lb-next{right:4px}.lb-close{top:8px;right:8px}}

    body.density-comfortable tbody td{padding:14px 12px}
    body.density-compact tbody td{padding:8px 8px}

    @media print{ .kebab-wrap{display:none !important} }
  </style>
</head>
<body class="theme-auto density-comfortable">
  <header id="hdr">
    <div class="wrap">
      <div class="hdrbar">
        <h1>Auth0 RSS ビューア（ローカルXML読込・表表示・CSV/HTMLエクスポート）</h1>
        <button id="btnCollapse" class="collapse-btn" aria-expanded="true" aria-controls="controls"><span class="ico">▲</span>コントロールをたたむ</button>
      </div>
      <div id="controls" class="controls" role="region" aria-label="操作パネル">
        <div class="card">
          <label for="file">① XMLファイルを選択（例: Auth0_rss.xml）</label>
          <input id="file" type="file" accept=".xml, text/xml, application/xml" />
          <div class="hint">このHTMLは <b>localhost</b>（推奨）や <b>file://</b> で開けます。外部画像は <b>localhost</b> からの表示を推奨。<br>
            Auth0 の Changelog は <a href="https://auth0.com/changelog" target="_blank" rel="noopener noreferrer">https://auth0.com/changelog</a> にあります。</div>
        </div>
        <div class="card">
          <label for="q">② 絞り込み</label>
          <input id="q" type="text" placeholder="キーワード（タイトル・概要）…" />
          <div class="row cols-2">
            <div>
              <label for="dateFrom">日付（UTC）From</label>
              <input id="dateFrom" type="date" inputmode="none" placeholder="YYYY-MM-DD" />
            </div>
            <div>
              <label for="dateTo">日付（UTC）To</label>
              <input id="dateTo" type="date" inputmode="none" placeholder="YYYY-MM-DD" />
            </div>
          </div>
          <div class="inline-row">
            <button id="btnPreset7d" class="btn secondary">直近7日</button>
            <button id="btnPreset30d" class="btn secondary">直近30日</button>
            <button id="btnPreset6m" class="btn secondary">直近6か月</button>
            <button id="btnPreset1y" class="btn secondary">直近1年</button>
            <button id="btnClearDates" class="btn secondary">日付クリア</button>
          </div>
          <div class="hint">キーワードはタイトルにハイライト（HTML表示OFF時は概要も）。</div>
        </div>
        <div class="card">
          <label>③ 表示オプション</label>
          <div class="row">
            <div class="inline-row">
              <label style="display:flex;align-items:center;gap:.4rem">
                <input id="trustHtml" type="checkbox"> <!-- 既定 OFF -->
                <span>概要(<code>description</code>)を <b>HTMLとして表示</b>（<span class="warn">XSS注意</span>）</span>
              </label>
            </div>
            <div>
              <label style="display:flex;align-items:center;gap:.4rem">
                <input id="enableWhitelist" type="checkbox" checked>
                <span>画像/リンクの <b>ドメイン制限（ホワイトリスト）</b>を有効化</span>
              </label>
              <textarea id="whitelist" placeholder="例）cdn.auth0.com
サブドメインを許可する場合は *.auth0.com">cdn.auth0.com</textarea>
              <div class="hint">許可ドメインのみ <b>画像の表示</b>や <b>リンク遷移</b>を許可（<code>*.example.com</code> でサブドメイン含む）。無効化で全ドメイン許可。</div>
            </div>
            <div>
              <label for="linkSource">リンクURLに使用する要素</label>
              <select id="linkSource">
                <option value="guid" selected>guid（既定）</option>
                <option value="link">link@href（存在する場合）</option>
              </select>
              <div class="hint">RSSにより <code>guid</code> がURLでない場合があります。その場合は <code>link@href</code> を選択してください。</div>
            </div>
            <div class="row cols-2">
              <div>
                <label for="theme">テーマ</label>
                <select id="theme">
                  <option value="auto" selected>自動（OSに追従）</option>
                  <option value="light">ライト（白背景）</option>
                  <option value="dark">ダーク（黒背景）</option>
                </select>
                <div class="hint">白背景が見やすい場合は「ライト」、暗所では「ダーク」、環境に合わせるなら「自動」。</div>
              </div>
              <div>
                <label for="density">表示密度</label>
                <select id="density">
                  <option value="comfortable" selected>標準（読みやすさ優先）</option>
                  <option value="compact">コンパクト（情報量優先）</option>
                </select>
              </div>
            </div>
            <div class="inline-row">
              <button id="btnPrintFiltered" class="btn secondary">印刷（フィルタ後）</button>
            </div>
            <div class="hint">並び順は <b>pubDate 降順</b>（既定）・全件表示。日付はUTC解釈、表示は YYYY/MM/DD。</div>
          </div>
        </div>
        <div class="card">
          <label>④ エクスポート</label>
          <div class="btnrow">
            <button id="btnCsvAll" class="btn">CSV（全件）</button>
            <button id="btnCsvFiltered" class="btn secondary">CSV（フィルタ後）</button>
            <button id="btnHtmlAll" class="btn">HTML（全件）</button>
            <button id="btnHtmlFiltered" class="btn secondary">HTML（フィルタ後）</button>
          </div>
          <div class="hint">CSV: UTF-8（BOM付）/ CRLF / 列: <code>title, pubDate, description, guid, channel</code>｜HTML: 単一ファイル（インラインCSS）で表を保存</div>
          <div id="expMsg" class="hint" aria-live="polite"></div>
        </div>
      </div>
      <div class="stats" id="stats">未読込</div>
    </div>
  </header>

  <main class="wrap">
    <div class="card" style="overflow:auto">
      <table id="tbl">
        <colgroup>
          <col class="c-title">
          <col class="c-date">
          <col class="c-desc">
          <col class="c-link">
        </colgroup>
        <thead>
          <tr>
            <th class="col-title">タイトル</th>
            <th class="col-date">日付 (pubDate)</th>
            <th>概要 (description)</th>
            <th>リンク (guid)</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="4" style="padding:20px;color:var(--muted)">上部でXMLを選択してください。</td></tr></tbody>
      </table>
    </div>
    <div class="footer">※ このビューアはローカルで動作する静的HTMLです。ファイルはブラウザ外へ送信されません。</div>
  </main>

  <div id="lightbox" class="lightbox" aria-hidden="true" role="dialog" aria-label="画像ビューア">
    <div class="lb-inner">
      <button class="lb-close" id="lbClose" title="閉じる">✕</button>
      <img id="lbImg" class="lb-img" alt="full-size" />
      <div class="lb-nav">
        <button class="lb-btn lb-prev" id="lbPrev" title="前へ">◀</button>
        <button class="lb-btn lb-next" id="lbNext" title="次へ">▶</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const els = {
      header: $('#hdr'), btnCollapse: $('#btnCollapse'),
      file: $('#file'), q: $('#q'), trust: $('#trustHtml'), stats: $('#stats'), tbody: $('#tbody'),
      btnCsvAll: $('#btnCsvAll'), btnCsvFiltered: $('#btnCsvFiltered'), btnHtmlAll: $('#btnHtmlAll'), btnHtmlFiltered: $('#btnHtmlFiltered'),
      expMsg: $('#expMsg'), dateFrom: $('#dateFrom'), dateTo: $('#dateTo'),
      btnPreset7d: $('#btnPreset7d'), btnPreset30d: $('#btnPreset30d'), btnPreset6m: $('#btnPreset6m'), btnPreset1y: $('#btnPreset1y'), btnClearDates: $('#btnClearDates'),
      enableWhitelist: $('#enableWhitelist'), whitelist: $('#whitelist'), linkSource: $('#linkSource'),
      lb: $('#lightbox'), lbImg: $('#lbImg'), lbClose: $('#lbClose'), lbPrev: $('#lbPrev'), lbNext: $('#lbNext'),
      btnPrintFiltered: $('#btnPrintFiltered'), theme: $('#theme'), density: $('#density')
    };

    const LS_KEY = 'auth0_rss_viewer_settings_v6b';
    function saveSettings(){ const obj={ trust:els.trust.checked, enableWhitelist:els.enableWhitelist.checked, whitelist:els.whitelist.value, linkSource:els.linkSource.value, q:els.q.value, dateFrom:els.dateFrom.value, dateTo:els.dateTo.value, collapsed:els.header.classList.contains('collapsed'), theme:els.theme?.value, density:els.density?.value }; localStorage.setItem(LS_KEY, JSON.stringify(obj)); }
    function applyTheme(val){ const cls=['theme-auto','theme-light','theme-dark']; document.body.classList.remove(...cls); document.body.classList.add('theme-'+(val||'auto')); }
    function applyDensity(val){ const cls=['density-comfortable','density-compact']; document.body.classList.remove(...cls); document.body.classList.add('density-'+(val||'comfortable')); }
    function loadSettings(){ try{ const obj=JSON.parse(localStorage.getItem(LS_KEY)||'null'); if(!obj) return; els.trust.checked=!!obj.trust; els.enableWhitelist.checked=obj.enableWhitelist!==false; if(typeof obj.whitelist==='string') els.whitelist.value=obj.whitelist; if(obj.linkSource) els.linkSource.value=obj.linkSource; if(typeof obj.q==='string') els.q.value=obj.q; if(typeof obj.dateFrom==='string') els.dateFrom.value=obj.dateFrom; if(typeof obj.dateTo==='string') els.dateTo.value=obj.dateTo; if(obj.theme && els.theme){ els.theme.value=obj.theme; applyTheme(obj.theme);} if(obj.density && els.density){ els.density.value=obj.density; applyDensity(obj.density);} if(obj.collapsed){ setCollapsed(true,false);} }catch{} }

    const esc = (s='') => s.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[c]));
    function decodeHtmlEntitiesOnce(str=''){ const ta=document.createElement('textarea'); ta.innerHTML=str; return ta.value; }
    function decodeEntitiesDeep(str='', maxRounds=3){ let prev=str, cur=decodeHtmlEntitiesOnce(str), rounds=1; while(cur!==prev && rounds<maxRounds){ prev=cur; cur=decodeHtmlEntitiesOnce(prev); rounds++; } return cur; }

    function normHost(h){ return (h||'').trim().toLowerCase().replace(/^\*\./,'*.').replace(/^\.+/,''); }
    function parseWhitelist(){ const raw=(els.whitelist.value||'').split(/[\n,\s]+/).filter(Boolean).map(normHost); return raw; }
    function hostFromUrl(url){ try{ return new URL(url, location.origin).hostname.toLowerCase(); }catch{ return ''; } }
    function isAllowedUrl(url){ if(!els.enableWhitelist.checked) return true; const host=hostFromUrl(url); if(!host) return false; const wl=parseWhitelist(); if(wl.length===0) return false; return wl.some(p=>{ if(p.startsWith('*.')){ const base=p.slice(2); return host===base || host.endsWith('.'+base); } return host===p; }); }

    function isMalformedUrlAttr(val){ const v=(val||'').trim(); return v.startsWith('<a ') || /[<>]/.test(v); }

    function toHtmlFromPlain(text){ if(!text) return ''; let t=decodeEntitiesDeep(text);
      t=t.replace(/!\[([^\]]*)\]\(([^)\s]+)(?:\s+\"([^\"]+)\")?\)/g,(m,alt,url,title)=>{ if(!isAllowedUrl(url)||isMalformedUrlAttr(url)) return `<span class=\"blocked\" title=\"不正または許可外の画像URL\">[画像ブロック]</span>`; const a=esc(alt||''); const u=esc(url); const ti=title?` title=\"${esc(title)}\"`:''; return `<img src=\"${u}\" alt=\"${a}\" loading=\"lazy\" decoding=\"async\"${ti}>`; });
      t=t.replace(/\[([^\]]+)\]\(([^)\s]+)(?:\s+\"([^\"]+)\")?\)/g,(m,txt,url,title)=>{ if(!isAllowedUrl(url)||isMalformedUrlAttr(url)) return `<span class=\"blocked\" title=\"不正または許可外のリンク\">${esc(txt)}</span>`; const u=esc(url); const ti=title?` title=\"${esc(title)}\"`:''; return `<a href=\"${u}\" target=\"_blank\" rel=\"noopener noreferrer\"${ti}>${esc(txt)}</a>`; });
      t=t.replace(/(https?:\/\/[\w./#?=&%\-+,:;~!@()\[\]]+)/g,(m)=>{ if(!isAllowedUrl(m)||isMalformedUrlAttr(m)) return `<span class=\"blocked\" title=\"不正または許可外のリンク\">${esc(m)}</span>`; return `<a href=\"${esc(m)}\" target=\"_blank\" rel=\"noopener noreferrer\">${esc(m)}</a>`; });
      t=t.replace(/\n/g,'<br>'); return t; }

    function parseDate(s){ const d=new Date(s); const n=d.getTime(); return Number.isFinite(n)?n:0; }
    function pick(node, tag){ const el=node.querySelector(tag); if(!el) return ''; if(tag==='description') return el.innerHTML.trim(); return (el.textContent||'').trim(); }
    const pad2=n=>String(n).padStart(2,'0');
    function formatYYYYMMDD(ts, original){ if(Number.isFinite(ts)&&ts>0){ const d=new Date(ts); return `${d.getUTCFullYear()}/${pad2(d.getUTCMonth()+1)}/${pad2(d.getUTCDate())}`; } return original||''; }

    function sanitizeDescElement(root){
      root.querySelectorAll('script, iframe, object, embed, link, style').forEach(n=>n.remove());
      root.querySelectorAll('a[href]').forEach(a=>{ const href=a.getAttribute('href')||''; if(isMalformedUrlAttr(href)){ const span=document.createElement('span'); span.className='blocked'; span.title='不正なURL属性（HTML断片）'; span.textContent=a.textContent||href; a.replaceWith(span); return; } if(isAllowedUrl(href)){ a.target='_blank'; a.rel='noopener noreferrer'; } else { const host=hostFromUrl(href); const span=document.createElement('span'); span.className='blocked'; span.title=`ドメイン許可外: ${host}`; span.textContent=a.textContent||href; a.replaceWith(span);} });
      root.querySelectorAll('img[src]').forEach(img=>{ const src=img.getAttribute('src')||''; if(isMalformedUrlAttr(src)){ const span=document.createElement('span'); span.className='blocked'; span.title='不正な画像src（HTML断片）'; span.textContent='[画像ブロック]'; img.replaceWith(span); return; } if(isAllowedUrl(src)){ img.loading='lazy'; img.decoding='async'; img.style.cursor='zoom-in'; img.addEventListener('click', ()=>openLightbox(img.src)); } else { const host=hostFromUrl(src); const span=document.createElement('span'); span.className='blocked'; span.title=`ドメイン許可外: ${host}`; span.textContent='[画像ブロック]'; img.replaceWith(span);} });
    }

    function getLinkUrl(item){ if(els.linkSource.value==='link' && item.linkHref) return item.linkHref; return item.guid || item.linkHref || ''; }
    function descToPlainText(descRaw){ const div=document.createElement('div'); const looksHtml=/<\w+[^>]*>/.test(descRaw||''); div.innerHTML = looksHtml ? (descRaw||'') : toHtmlFromPlain(descRaw||''); return div.textContent || ''; }
    function highlightText(text, needle){ if(!needle) return esc(text||''); const safe=esc(text||''); try{ const re=new RegExp('('+needle.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','ig'); return safe.replace(re,'<mark class="h">$1</mark>'); }catch{ return safe; } }

    function buildRow(item){ const tr=document.createElement('tr'); const tdTitle=document.createElement('td'); tdTitle.className='col-title'; const tdDate=document.createElement('td'); tdDate.className='col-date'; const tdDesc=document.createElement('td'); const tdLink=document.createElement('td'); const q=(els.q.value||'').trim(); const titleBase=item.title||'(no title)'; const raw=decodeEntitiesDeep(item.description||''); const descPlain=descToPlainText(raw); tr.dataset.title=item.title||''; tr.dataset.desc=descPlain; tdTitle.innerHTML=`<strong>${highlightText(titleBase, q)}</strong>`;
      const kebabWrap=document.createElement('span'); kebabWrap.className='kebab-wrap'; const kebabBtn=document.createElement('button'); kebabBtn.type='button'; kebabBtn.className='kebab-btn'; kebabBtn.setAttribute('aria-haspopup','menu'); kebabBtn.setAttribute('aria-expanded','false'); kebabBtn.title='行アクション'; kebabBtn.textContent='⋯'; const menu=document.createElement('div'); menu.className='menu'; menu.setAttribute('role','menu'); menu.innerHTML=`\n        <button class="mi" role="menuitem" data-act="copy-title"><span class="ico">📋</span><span>題名をコピー (t)</span></button>\n        <button class="mi" role="menuitem" data-act="copy-desc"><span class="ico">📝</span><span>概要をコピー (d)</span></button>\n        <button class="mi" role="menuitem" data-act="search-g"><span class="ico">🔎</span><span>Google で検索 (g)</span></button>\n      `; kebabWrap.append(kebabBtn, menu); tdTitle.appendChild(kebabWrap);
      tdDate.textContent=formatYYYYMMDD(item._ts,item.pubDate); if(item.pubDate) tdDate.title=item.pubDate;
      const descDiv=document.createElement('div'); descDiv.className='desc'; if(els.trust.checked){ const looksHtml=/<\w+[^>]*>/.test(raw); descDiv.innerHTML=looksHtml?raw:toHtmlFromPlain(raw); sanitizeDescElement(descDiv); } else { const descText=raw; descDiv.innerHTML=highlightText(descText, q); } tdDesc.appendChild(descDiv);
      const href=getLinkUrl(item); if(href){ if(!isMalformedUrlAttr(href) && isAllowedUrl(href)){ const a=document.createElement('a'); a.href=href; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent=href; tdLink.appendChild(a);} else { const span=document.createElement('span'); span.className='blocked'; span.title=isMalformedUrlAttr(href)?'不正なリンクURL（HTML断片）':`ドメイン許可外: ${hostFromUrl(href)}`; span.textContent=href; tdLink.appendChild(span);} }
      kebabBtn.addEventListener('click',(e)=>{ e.stopPropagation(); closeAllMenus(); menu.classList.toggle('open'); const expanded=menu.classList.contains('open'); kebabBtn.setAttribute('aria-expanded', expanded?'true':'false'); });
      menu.addEventListener('click',(e)=>{ const btn=e.target.closest('[data-act]'); if(!btn) return; performAction(btn.dataset.act, tr); closeAllMenus(); });
      tr.append(tdTitle, tdDate, tdDesc, tdLink); return tr; }

    function closeAllMenus(){ $$('.menu.open').forEach(m=>{ m.classList.remove('open'); m.previousElementSibling?.setAttribute('aria-expanded','false'); }); }
    function copyText(text, okMsg){ if(!text){ els.expMsg.textContent='コピー対象がありません。'; return; } navigator.clipboard?.writeText(text).then(()=>{ els.expMsg.textContent=okMsg; setTimeout(()=>els.expMsg.textContent='',1500); }); }
    function performAction(act, row){ if(!row){ row=els.tbody.querySelector('tr'); } if(!row) return; if(act==='copy-title'){ copyText(row.dataset.title||'','タイトルをコピーしました。'); } else if(act==='copy-desc'){ copyText(row.dataset.desc||'','概要をコピーしました。'); } else if(act==='search-g'){ const title=row.dataset.title||''; const q=encodeURIComponent(title); window.open(`https://www.google.com/search?q=${q}`,'_blank','noopener'); } }

    function parseUTCBoundary(dateStr,end=false){ if(!dateStr) return null; const t=end?'T23:59:59.999Z':'T00:00:00.000Z'; const d=new Date(dateStr+t); const n=d.getTime(); return Number.isFinite(n)?n:null; }
    function toDateInputValueUTC(date){ const y=date.getUTCFullYear(); const m=String(date.getUTCMonth()+1).padStart(2,'0'); const d=String(date.getUTCDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }

    function filterItems(items){ const q=(els.q.value||'').toLowerCase(); const fromMs=parseUTCBoundary(els.dateFrom.value,false); const toMs=parseUTCBoundary(els.dateTo.value,true); const out=[]; for(const it of items){ if(q){ const hay=`${it.title}\n${it.description}`.toLowerCase(); if(!hay.includes(q)) continue; } if(fromMs!==null && it._ts<fromMs) continue; if(toMs!==null && it._ts>toMs) continue; out.push(it);} return out; }

    function render(items){ els.tbody.innerHTML=''; const filtered=filterItems(items); let count=0; for(const it of filtered){ els.tbody.appendChild(buildRow(it)); count++; } els.stats.textContent=`${items.length.toLocaleString()}件 読込済み / フィルタ後 ${count.toLocaleString()}件`; if(count===0){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=4; td.style.color='var(--muted)'; td.style.padding='16px'; const q=(els.q.value||''); td.textContent=q?'条件に一致する項目がありません。':'データがありません。'; tr.appendChild(td); els.tbody.appendChild(tr);} saveSettings(); }

    async function handleFile(file){ if(!file) return; const text=await file.text(); const xml=new DOMParser().parseFromString(text,'text/xml'); const err=xml.querySelector('parsererror'); if(err){ els.stats.textContent='XMLの解析に失敗しました。ファイル内容をご確認ください。'; els.tbody.innerHTML=`<tr><td colspan=\"4\" style=\"color:var(--danger);padding:16px\">${esc(err.textContent)}</td></tr>`; return; } let items=Array.from(xml.getElementsByTagName('item')); if(items.length===0) items=Array.from(xml.getElementsByTagName('entry')); const channelTitle=(xml.querySelector('channel>title')||xml.querySelector('feed>title'))?.textContent?.trim(); const mapped=items.map(node=>{ const title=pick(node,'title'); const pubDate=pick(node,'pubDate')||pick(node,'updated')||pick(node,'published'); const description=pick(node,'description')||pick(node,'content')||pick(node,'summary'); let guid=pick(node,'guid'); let linkHref=''; const linkEl=node.querySelector('link[href]'); if(linkEl) linkHref=(linkEl.getAttribute('href')||'').trim(); if(!guid) guid=pick(node,'id'); return { title, pubDate, description, guid, linkHref, channelTitle, _ts:parseDate(pubDate) }; }); mapped.sort((a,b)=>b._ts-a._ts); window.__ITEMS=mapped; window.__CHANNEL=channelTitle||'rss'; render(mapped); els.expMsg.textContent=''; }

    function todayUTC(){ const t=new Date(); return new Date(Date.UTC(t.getUTCFullYear(), t.getUTCMonth(), t.getUTCDate())); }
    function setRange(fromDate,toDate){ els.dateFrom.value=toDateInputValueUTC(fromDate); els.dateTo.value=toDateInputValueUTC(toDate); if(window.__ITEMS) render(window.__ITEMS); }
    function applyLastNDays(n){ const to=todayUTC(); const from=new Date(to.getTime()); from.setUTCDate(from.getUTCDate()-(n-1)); setRange(from,to); }
    function applyLastMonths(m){ const to=todayUTC(); const from=new Date(to.getTime()); from.setUTCMonth(from.getUTCMonth()-m); setRange(from,to); }
    function applyLastYears(y){ const to=todayUTC(); const from=new Date(to.getTime()); from.setUTCFullYear(from.getUTCFullYear()-y); setRange(from,to); }
    function clearDates(){ els.dateFrom.value=''; els.dateTo.value=''; if(window.__ITEMS) render(window.__ITEMS); }

    function csvEscape(val){ if(val===null||val===undefined) return '""'; const s=String(val).replace(/\r\n|\r|\n/g,'\n').replace(/"/g,'""'); return '"'+s+'"'; }
    function toCsv(items){ const header=['title','pubDate','description','guid','channel']; const lines=[header.map(csvEscape).join(',')]; for(const it of items){ lines.push([csvEscape(it.title||''),csvEscape(it.pubDate||''),csvEscape(it.description||''),csvEscape(it.guid||''),csvEscape(it.channelTitle||'')].join(',')); } return lines.join('\r\n')+'\r\n'; }
    function timestampUTC(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+'_'+pad(d.getUTCHours())+pad(d.getUTCMinutes())+pad(d.getUTCSeconds())+'UTC'; }
    function downloadCsv(items, kind){ if(!items||!items.length){ els.expMsg.textContent='エクスポート対象がありません。'; return; } const csv=toCsv(items); const bom=new Uint8Array([0xEF,0xBB,0xBF]); const blob=new Blob([bom,csv],{type:'text/csv;charset=utf-8;'}); const ch=(window.__CHANNEL||'rss').replace(/[^\w\-]+/g,'_').slice(0,40)||'rss'; const fname=`${ch}_${kind}_${timestampUTC()}.csv`; const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fname; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); els.expMsg.innerHTML=`<span class=\"ok\">CSVを保存しました：</span> ${fname}`; }

    function sanitizeHtmlString(html){ const div=document.createElement('div'); div.innerHTML=html; sanitizeDescElement(div); return div.innerHTML; }
    function buildRowsHTML(items){ let html=''; const q=(els.q.value||'').trim(); for(const it of items){ const dateText=formatYYYYMMDD(it._ts,it.pubDate); const dateTitle=it.pubDate?` title=\"${esc(it.pubDate)}\"`:''; const raw=decodeEntitiesDeep(it.description||''); let descHtml=''; if(els.trust.checked){ const looksHtml=/<\w+[^>]*>/.test(raw); descHtml=sanitizeHtmlString(looksHtml?raw:toHtmlFromPlain(raw)); } else { descHtml=esc(raw); if(q){ const re=new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','ig'); descHtml=descHtml.replace(re,'<mark class=\"h\">$1</mark>'); } } const titleHtml=`<strong>${highlightText(it.title||'(no title)', q)}</strong>`; const href=(els.linkSource.value==='link' && it.linkHref)? it.linkHref : (it.guid||it.linkHref||''); let linkCell=''; if(href){ if(!isMalformedUrlAttr(href) && isAllowedUrl(href)){ linkCell=`<a href=\"${esc(href)}\" target=\"_blank\" rel=\"noopener noreferrer\">${esc(href)}</a>`; } else { linkCell=`<span class=\"blocked\" title=\"${isMalformedUrlAttr(href)?'不正なリンクURL（HTML断片）':('ドメイン許可外: '+esc(hostFromUrl(href)))}\">${esc(href)}</span>`; } } html += `\n<tr>\n  <td class=\"col-title\">${titleHtml}</td>\n  <td class=\"col-date\"${dateTitle}>${esc(dateText)}</td>\n  <td><div class=\"desc\">${descHtml}</div></td>\n  <td>${linkCell}</td>\n</tr>`; } return html; }
    function buildExportHTML(items, kind){ const ch=(window.__CHANNEL||'rss'); const q=(els.q.value||'').trim(); const df=els.dateFrom.value||''; const dt=els.dateTo.value||''; const gen=new Date(); const pad=n=>String(n).padStart(2,'0'); const genLocal=`${gen.getFullYear()}/${pad(gen.getMonth()+1)}/${pad(gen.getDate())} ${pad(gen.getHours())}:${pad(gen.getMinutes())}:${pad(gen.getSeconds())}`; const style=`:root{--bg:#f7f9fc;--card:#fff;--txt:#1e293b;--muted:#5b677a;--border:#d7e0ea;--hl:#fff1a6}
        body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif}
        .wrap{max-width:1200px;margin:0 auto;padding:16px}
        h1{margin:0 0 8px 0;font-size:1.1rem;color:#5b677a}
        .meta{color:#5b677a;font-size:.9rem;margin-bottom:12px}
        table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed;background:#fff;border:1px solid var(--border);border-radius:10px;overflow:hidden}
        thead th{position:sticky;top:0;background:#f9fbfe;border-bottom:1px solid var(--border);text-align:left;padding:10px;font-size:.9rem;color:#5b677a}
        tbody td{vertical-align:top;border-bottom:1px solid var(--border);padding:12px 10px;}
        tbody tr:nth-child(odd) td{background:#f6f9fe}
        col.c-title{width:16%} col.c-date{width:9%} col.c-desc{width:65%} col.c-link{width:10%}
        .col-title{min-width:200px}
        .col-date{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .desc{white-space:pre-wrap;word-wrap:break-word;overflow-wrap:anywhere}
        .desc img{max-width:100%;height:auto;border-radius:6px;border:1px solid #d7e0ea}
        .badge{display:none !important}
        mark.h{background:var(--hl);color:#222;padding:0 .15em;border-radius:3px}
        @page{size:A4;margin:15mm 12mm}
        @media print{ html,body{background:#fff;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact} a[href]::after{content:" (" attr(href) ")";font-size:.9em;color:#555} thead{display:table-header-group} tfoot{display:table-footer-group} tr, img{page-break-inside:avoid;break-inside:avoid} .desc{orphans:3;widows:3} }`;
      const rows=buildRowsHTML(items);
      return `<!DOCTYPE html>\n<html lang=\"ja\">\n<head>\n<meta charset=\"utf-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n<title>${esc(ch)} – 表エクスポート (${kind})</title>\n<style>${style}</style>\n</head>\n<body>\n<div class=\"wrap\">\n  <h1>${esc(ch)} – 表エクスポート (${kind})</h1>\n  <div class=\"meta\">生成: ${esc(genLocal)} / 条件: ${q?`キーワード=\"${esc(q)}\" `:''}${df||dt?`日付(UTC)=${esc(df||'')}${(df||dt)&&'〜'}${esc(dt||'')}`:''}</div>\n  <table>\n    <colgroup>\n      <col class=\"c-title\"><col class=\"c-date\"><col class=\"c-desc\"><col class=\"c-link\">\n    </colgroup>\n    <thead><tr><th>タイトル</th><th>日付</th><th>概要</th><th>リンク</th></tr></thead>\n    <tbody>${rows || '<tr><td colspan=4 style=\'color:#5b677a;padding:16px\'>データがありません。</td></tr>'}</tbody>\n  </table>\n</div>\n</body>\n</html>`; }
    function downloadHtml(items, kind){ if(!items||!items.length){ els.expMsg.textContent='エクスポート対象がありません。'; return; } const html=buildExportHTML(items, kind); const blob=new Blob([html],{type:'text/html;charset=utf-8;'}); const ch=(window.__CHANNEL||'rss').replace(/[^\w\-]+/g,'_').slice(0,40)||'rss'; const fname=`${ch}_table_${kind}_${timestampUTC()}.html`; const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fname; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); els.expMsg.innerHTML=`<span class=\"ok\">HTMLを保存しました：</span> ${fname}`; }

    // ========== Lightbox functions (FIX: ensure defined before event listeners) ==========
    let currentImages=[]; let currentIndex=-1;
    function collectImages(){ currentImages = $$('.desc img').map(img=>img.src); }
    function openLightbox(src){ collectImages(); currentIndex=currentImages.indexOf(src); if(currentIndex<0){ currentImages.push(src); currentIndex=currentImages.length-1; } els.lbImg.src=src; els.lb.classList.add('open'); els.lb.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
    function closeLightbox(){ els.lb.classList.remove('open'); els.lb.setAttribute('aria-hidden','true'); els.lbImg.src=''; document.body.style.overflow=''; }
    function showPrev(){ if(currentImages.length<2) return; currentIndex=(currentIndex-1+currentImages.length)%currentImages.length; els.lbImg.src=currentImages[currentIndex]; }
    function showNext(){ if(currentImages.length<2) return; currentIndex=(currentIndex+1)%currentImages.length; els.lbImg.src=currentImages[currentIndex]; }

    // ========== Global event handlers ==========
    function setCollapsed(on, save=true){ if(on){ els.header.classList.add('collapsed'); els.btnCollapse.setAttribute('aria-expanded','false'); els.btnCollapse.innerHTML='<span class="ico">▼</span>コントロールをひらく'; } else { els.header.classList.remove('collapsed'); els.btnCollapse.setAttribute('aria-expanded','true'); els.btnCollapse.innerHTML='<span class="ico">▲</span>コントロールをたたむ'; } if(save) saveSettings(); }
    els.btnCollapse.addEventListener('click', ()=>{ setCollapsed(!els.header.classList.contains('collapsed')); });

    document.addEventListener('click', (e)=>{ const t=e.target; if(!t.closest('.kebab-wrap')) closeAllMenus(); if(t===els.lb){ closeLightbox(); } });
    els.lbClose.addEventListener('click', closeLightbox);
    els.lbPrev.addEventListener('click', showPrev);
    els.lbNext.addEventListener('click', showNext);

    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeAllMenus(); if(els.lb.classList.contains('open')) closeLightbox(); } const tag=(e.target.tagName||'').toLowerCase(); if(['input','textarea','select'].includes(tag)) return; if(['t','d','g','T','D','G'].includes(e.key)){ const act=(e.key.toLowerCase()==='t')?'copy-title':(e.key.toLowerCase()==='d'?'copy-desc':(e.key.toLowerCase()==='g'?'search-g':'')); if(!act) return; e.preventDefault(); const row=document.querySelector('tbody tr:hover') || document.activeElement?.closest('tr') || els.tbody.querySelector('tr'); if(row) performAction(act, row);} });

    // init
    loadSettings();
    els.file.addEventListener('change', ()=> handleFile(els.file.files[0]));
    els.q.addEventListener('input', ()=> window.__ITEMS && render(window.__ITEMS));
    els.trust.addEventListener('change', ()=> window.__ITEMS && render(window.__ITEMS));
    els.enableWhitelist.addEventListener('change', ()=> window.__ITEMS && render(window.__ITEMS));
    els.whitelist.addEventListener('input', ()=> window.__ITEMS && render(window.__ITEMS));
    els.linkSource.addEventListener('change', ()=> window.__ITEMS && render(window.__ITEMS));
    els.dateFrom.addEventListener('change', ()=> window.__ITEMS && render(window.__ITEMS));
    els.dateTo.addEventListener('change', ()=> window.__ITEMS && render(window.__ITEMS));
    els.btnPreset7d.addEventListener('click', (e)=>{ e.preventDefault(); applyLastNDays(7); });
    els.btnPreset30d.addEventListener('click', (e)=>{ e.preventDefault(); applyLastNDays(30); });
    els.btnPreset6m.addEventListener('click', (e)=>{ e.preventDefault(); applyLastMonths(6); });
    els.btnPreset1y.addEventListener('click', (e)=>{ e.preventDefault(); applyLastYears(1); });
    els.btnClearDates.addEventListener('click', (e)=>{ e.preventDefault(); clearDates(); });
    els.btnCsvAll?.addEventListener('click', ()=>{ if(window.__ITEMS) downloadCsv(window.__ITEMS,'all'); });
    els.btnCsvFiltered?.addEventListener('click', ()=>{ if(window.__ITEMS) downloadCsv(filterItems(window.__ITEMS),'filtered'); });
    els.btnHtmlAll?.addEventListener('click', ()=>{ if(window.__ITEMS) downloadHtml(window.__ITEMS,'all'); });
    els.btnHtmlFiltered?.addEventListener('click', ()=>{ if(window.__ITEMS) downloadHtml(filterItems(window.__ITEMS),'filtered'); });
    els.btnPrintFiltered?.addEventListener('click', ()=>{ if(window.__ITEMS) printFiltered(); });

    els.theme?.addEventListener('change', ()=>{ applyTheme(els.theme.value); saveSettings(); });
    els.density?.addEventListener('change', ()=>{ applyDensity(els.density.value); saveSettings(); });
  </script>
</body>
</html>