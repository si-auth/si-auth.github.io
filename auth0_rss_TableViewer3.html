<!DOCTYPE html>
<html lang="ja">
<head>
  <!--
  Auth0 RSS ビューア v4.1.13 – タイトル簡略版（<title>/見出しは製品名+バージョンのみ）
  Last-Updated: 2025-10-03 10:27:17Z (UTC)
  Default feed: https://si-auth.github.io/rss/auth0-changelog/rss.xml
-->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Auth0 RSS ビューア v4.1.13</title>
  <style>
    :root{
      --bg:#f7f9fc; --card:#ffffff; --txt:#1e293b; --muted:#5b677a; --accent:#0b6bcb; --border:#d7e0ea;
      --danger:#d62323; --ok:#17803d; --blocked:#b36b00; --hl:#fff1a6;
      --row:#ffffff; --rowAlt:#f2f6fb; --hover:#eef3fb; --link:#0b6bcb;
    }
    body.theme-light{ --bg:#f7f9fc; --card:#ffffff; --txt:#1e293b; --muted:#5b677a; --accent:#0b6bcb; --border:#d7e0ea; --danger:#d62323; --ok:#17803d; --blocked:#b36b00; --hl:#fff1a6; --row:#ffffff; --rowAlt:#f2f6fb; --hover:#eef3fb; --link:#0b6bcb; }
    body.theme-dark{ --bg:#0b0c10; --card:#12151a; --txt:#e6e6e6; --muted:#a8b0bd; --accent:#3aa0ff; --border:#263141; --danger:#ff6464; --ok:#2ecc71; --blocked:#ffb74d; --hl:#ffe08a; --row:#12151a; --rowAlt:#0f141f; --hover:#121826; --link:#6bb8ff; }
    @media (prefers-color-scheme: dark){ body.theme-auto{ --bg:#0b0c10; --card:#12151a; --txt:#e6e6e6; --muted:#a8b0bd; --accent:#3aa0ff; --border:#263141; --danger:#ff6464; --ok:#2ecc71; --blocked:#ffb74d; --hl:#ffe08a; --row:#12151a; --rowAlt:#0f141f; --hover:#121826; --link:#6bb8ff; } }

    html,body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif}
    a{color:var(--link)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg),rgba(0,0,0,.02));backdrop-filter:blur(4px)}
    .wrap{max-width:min(1800px,98vw);margin:0 auto;padding:12px 16px}
    h1{margin:.2rem 0 .4rem 0;font-size:1.05rem;color:var(--muted);font-weight:600}

    .hdrbar{position:relative;display:flex;align-items:center;gap:8px;min-height:38px}
    .hdrbar h1{padding-right:200px}
    .collapse-btn{position:absolute;right:0;top:0;appearance:none;border:1px solid var(--border);background:color-mix(in oklab, var(--card), var(--bg));color:var(--txt);padding:5px 9px;border-radius:8px;cursor:pointer;font-size:.85rem}
    .collapse-btn:hover{border-color:color-mix(in oklab, var(--border), var(--accent) 45%);background:color-mix(in oklab, var(--card), var(--accent) 8%)}
    .collapse-btn .ico{margin-right:.35em}

    header.collapsed h1{display:none}
    header.collapsed .controls{display:none}
    header.collapsed .wrap{padding:8px 16px}

    .controls{display:grid;grid-template-columns:1fr;gap:10px;margin-top:6px}
    @media(min-width:1200px){.controls{grid-template-columns:1.15fr 1.15fr 1fr 1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px}

    /* details 折りたたみ（①と③） */
    details.card{padding:0}
    details.card > summary{list-style:none; cursor:pointer; padding:8px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    details.card > summary::-webkit-details-marker{display:none}
    details.card > summary .sum-title{font-size:.9rem;color:var(--muted);font-weight:600;margin-right:auto}
    details.card > .content{padding:10px}

    /* ①RSSフィード取得 内部（小さめ固定） */
    .source-grid{display:grid;grid-template-columns:1fr;gap:8px}
    .source-box{border:1px dashed var(--border);border-radius:8px;padding:8px}
    .source-title{font-weight:600;color:var(--muted);margin-bottom:6px;font-size:.9rem}
    .pill{display:inline-block;background:color-mix(in oklab, var(--card), var(--bg) 20%);border:1px solid var(--border);border-radius:999px;padding:3px 8px;font-size:.8rem;color:var(--muted)}
    .sum-inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

    label{font-size:.85rem;color:var(--muted)}
    input[type="file"],input[type="text"],input[type="date"],textarea,select{width:100%;padding:7px;border-radius:8px;border:1px solid var(--border);background:color-mix(in oklab, var(--card), var(--bg) 10%);color:var(--txt);font-size:.9rem}
    textarea{min-height:68px;resize:vertical}
    input[type="checkbox"]{transform:scale(1.05);margin-right:6px}
    .hint{font-size:.8rem;color:var(--muted)}
    .stats{margin-top:4px;font-size:.85rem;color:var(--muted)}

    table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
    thead th{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);text-align:left;padding:10px;font-size:.9rem;color:var(--muted)}
    tbody td{vertical-align:top;border-bottom:1px solid var(--border);padding:12px 10px;background:var(--row)}
    tbody tr:nth-child(odd) td{background:var(--rowAlt)}
    tbody tr:hover td{background:var(--hover)}

    col.c-title{width:16%}
    col.c-date{width:9%}
    col.c-desc{width:65%}
    col.c-link{width:10%}

    .col-title{min-width:220px}
    .col-date{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .desc{white-space:pre-wrap;word-wrap:break-word;overflow-wrap:anywhere}
    .desc img{max-width:100%;height:auto;border-radius:6px;border:1px solid var(--border);cursor:zoom-in}

    .badge{display:none !important}
    .warn{color:var(--danger)}
    .ok{color:var(--ok)}
    .blocked{display:inline-block;padding:2px 6px;border-radius:6px;background:color-mix(in oklab, var(--blocked), var(--bg) 85%);border:1px dashed color-mix(in oklab, var(--blocked), #000 50%);color:color-mix(in oklab, var(--blocked), #000 35%);font-size:.8rem}
    .footer{color:var(--muted);font-size:.85rem;margin:16px 0}

    .btnrow{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}

    /* ▼ 全ボタン共通（コンパクト） */
    .btn{appearance:none;border:1px solid var(--border);background:color-mix(in oklab, var(--card), var(--bg));color:var(--txt);padding:4px 8px;border-radius:8px;cursor:pointer;font-size:.85rem}
    .btn:hover{border-color:color-mix(in oklab, var(--border), var(--accent) 45%);background:color-mix(in oklab, var(--card), var(--accent) 8%)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:color-mix(in oklab, var(--card), var(--bg) 5%);color:var(--txt)}

    .row{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
    @media(min-width:520px){.row.cols-2{grid-template-columns:1fr 1fr}}
    .inline-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}

    mark.h{background:var(--hl);color:#222;padding:0 .15em;border-radius:3px}

    .kebab-wrap{position:relative;display:inline-block;margin-left:6px}
    .kebab-btn{appearance:none;border:1px solid var(--border);background:color-mix(in oklab, var(--card), var(--bg));color:var(--txt);border-radius:6px;cursor:pointer;padding:2px 8px;line-height:1}
    .kebab-btn:hover{background:color-mix(in oklab, var(--card), var(--accent) 8%);border-color:color-mix(in oklab, var(--border), var(--accent) 45%)}
    .kebab-btn[aria-expanded="true"]{background:color-mix(in oklab, var(--card), var(--accent) 14%)}
    .menu{position:absolute;right:0;top:120%;min-width:180px;background:color-mix(in oklab, var(--card), var(--bg) 6%);border:1px solid color-mix(in oklab, var(--border), #000 10%);border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:6px;display:none;z-index:5}
    .menu.open{display:block}
    .menu .mi{display:flex;gap:8px;align-items:center;width:100%;padding:8px 10px;background:transparent;border:none;color:var(--txt);border-radius:6px;text-align:left;cursor:pointer}
    .menu .mi:hover{background:color-mix(in oklab, var(--card), var(--accent) 8%)}
    .menu .mi .ico{font-size:1rem;opacity:.9}

    body.density-comfortable tbody td{padding:14px 12px}
    body.density-compact tbody td{padding:8px 8px}

    @media print{ .kebab-wrap{display:none !important} }

    /* ====== ② 絞り込み：日付フォーム 横並び & 入力幅2/3 ====== */
    #filterCard .row.cols-2 > div{ display:flex; justify-content:space-between; align-items:center; gap:8px }
    #filterCard .row.cols-2 > div label{ flex:1 1 auto }
    #filterCard .row.cols-2 > div input[type="date"]{ flex:0 0 66%; max-width:66% }
  </style>
</head>
<body class="theme-auto density-comfortable">
  <header id="hdr">
    <div class="wrap">
      <div class="hdrbar">
        <h1>Auth0 RSS ビューア v4.1.13</h1>
        <button id="btnCollapse" class="collapse-btn" aria-expanded="true" aria-controls="controls"><span class="ico">▲</span>コントロールをたたむ</button>
      </div>
      <div id="controls" class="controls" role="region" aria-label="操作パネル">

        <!-- ① RSSフィード取得（折りたたみ可：既定で開） -->
        <details class="card" open>
          <summary>
            <span class="sum-title">① RSSフィード取得</span>
            <span class="sum-inline">
              <span class="pill" id="fileNameStatus" title="選択されたファイル名">ローカルXML: 未選択</span>
              <button id="btnFilePicker" class="btn secondary" type="button">XMLを選択…</button>
            </span>
          </summary>
          <div class="content">
            <div class="source-grid">
              <div class="source-box">
                <div class="source-title">ローカルファイルから</div>
                <label for="file">XMLファイルを選択</label>
                <input id="file" type="file" accept=".xml, text/xml, application/xml" />
                <div class="hint">ファイルはブラウザ外へ送信されません。</div>
              </div>
              <div class="source-box">
                <div class="source-title">ネットワークから</div>
                <label for="feedUrl">フィードURL（同一オリジン推奨）</label>
                <input id="feedUrl" type="text" value="https://si-auth.github.io/rss/auth0-changelog/rss.xml" placeholder="https://example.com/feed.xml" />
                <div class="inline-row" style="margin-top:6px">
                  <label style="display:flex;align-items:center;gap:.4rem">
                    <input id="autoLoad" type="checkbox" checked>
                    <span>起動時に <code>feedUrl</code> を自動で読み込む</span>
                  </label>
                  <button id="btnFetchNow" class="btn">今すぐ取得</button>
                </div>
                <div class="hint">同一オリジンならCORS不要で安定します。GitHub Pages に配置するのが簡単です。</div>
              </div>
            </div>
          </div>
        </details>

        <!-- ② 絞り込み -->
        <div id="filterCard" class="card">
          <label for="q">② 絞り込み</label>
          <input id="q" type="text" placeholder="キーワード（タイトル・概要）…" />
          <div class="row cols-2">
            <div>
              <label for="dateFrom">日付（UTC）From</label>
              <input id="dateFrom" type="date" inputmode="none" placeholder="YYYY-MM-DD" />
            </div>
            <div>
              <label for="dateTo">日付（UTC）To</label>
              <input id="dateTo" type="date" inputmode="none" placeholder="YYYY-MM-DD" />
            </div>
          </div>
          <div class="inline-row">
            <button id="btnPreset7d" class="btn secondary">直近7日</button>
            <button id="btnPreset30d" class="btn secondary">直近30日</button>
            <button id="btnPreset6m" class="btn secondary">直近6か月</button>
            <button id="btnPreset1y" class="btn secondary">直近1年</button>
            <button id="btnClearDates" class="btn secondary">日付クリア</button>
          </div>
          <div class="hint">キーワードはタイトルにハイライト（HTML表示OFF時は概要も）。</div>
        </div>

        <!-- ③ 表示オプション（折りたたみ可：既定で閉） -->
        <details class="card">
          <summary>
            <span class="sum-title">③ 表示オプション</span>
            <span class="sum-inline">
              <label style="display:flex;align-items:center;gap:.35rem" title="概要(description)をHTMLとして表示（XSS注意）">
                <input id="trustHtml" type="checkbox">
                <span>HTML表示</span>
              </label>
              <label style="display:flex;align-items:center;gap:.35rem" title="画像/リンクのドメイン制限（ホワイトリスト）を有効化">
                <input id="enableWhitelist" type="checkbox" checked>
                <span>ホワイトリスト</span>
              </label>
            </span>
          </summary>
          <div class="content">
            <div class="row">
              <div>
                <label for="whitelist">許可ドメイン（ホワイトリスト）</label>
                <textarea id="whitelist" placeholder="例）*.auth0.com
サブドメインを許可する場合は *.example.com">*.auth0.com</textarea>
                <div class="hint">許可ドメインのみ <b>画像の表示</b>や <b>リンク遷移</b>を許可（<code>*.example.com</code> でサブドメイン含む）。無効化で全ドメイン許可。</div>
              </div>
              <div>
                <label for="linkSource">リンクURLに使用する要素</label>
                <select id="linkSource">
                  <option value="guid" selected>guid（既定）</option>
                  <option value="link">link@href（存在する場合）</option>
                </select>
                <div class="hint">RSSにより <code>guid</code> がURLでない場合があります。その場合は <code>link@href</code> を選択してください。</div>
              </div>
              <div class="row cols-2">
                <div>
                  <label for="theme">テーマ</label>
                  <select id="theme">
                    <option value="auto" selected>自動（OSに追従）</option>
                    <option value="light">ライト（白背景）</option>
                    <option value="dark">ダーク（黒背景）</option>
                  </select>
                </div>
                <div>
                  <label for="density">表示密度（表）</label>
                  <select id="density">
                    <option value="comfortable" selected>標準（読みやすさ優先）</option>
                    <option value="compact">コンパクト（情報量優先）</option>
                  </select>
                </div>
              </div>
              <div class="hint">並び順は <b>pubDate 降順</b>（既定）・全件表示。日付はUTC解釈、表示は YYYY/MM/DD。</div>
            </div>
          </div>
        </details>

        <!-- ④ エクスポート（折りたたみ不可：常時展開） -->
        <div class="card">
          <label>④ エクスポート</label>
          <div class="btnrow">
            <button id="btnCsvAll" class="btn">CSV（全件）</button>
            <button id="btnCsvFiltered" class="btn secondary">CSV（フィルタ後）</button>
            <button id="btnHtmlAll" class="btn">HTML（全件）</button>
            <button id="btnHtmlFiltered" class="btn secondary">HTML（フィルタ後）</button>
            <button id="btnPrintFiltered" class="btn secondary">印刷（フィルタ後）</button>
          </div>
          <div class="hint">CSV: UTF-8（BOM付）/ CRLF / 列: <code>title, pubDate, description, guid, channel</code>｜HTML: 単一ファイル（インラインCSS）で表を保存</div>
          <div id="expMsg" class="hint" aria-live="polite"></div>
        </div>

      </div>
      <div class="stats" id="stats">未読込</div>
    </div>
  </header>

  <main class="wrap">
    <div class="card" style="overflow:auto">
      <table id="tbl">
        <colgroup>
          <col class="c-title">
          <col class="c-date">
          <col class="c-desc">
          <col class="c-link">
        </colgroup>
        <thead>
          <tr>
            <th class="col-title">タイトル</th>
            <th class="col-date">日付 (pubDate)</th>
            <th>概要 (description)</th>
            <th>リンク (guid)</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="4" style="padding:20px;color:var(--muted)">起動時に自動取得、または上部でURL指定/ファイル選択をしてください。</td></tr></tbody>
      </table>
    </div>
    <div class="footer">※ このビューアはローカルで動作する静的HTMLです。ファイルはブラウザ外へ送信されません。</div>
  </main>

  <div id="lightbox" class="lightbox" aria-hidden="true" role="dialog" aria-label="画像ビューア">
    <div class="lb-inner">
      <button class="lb-close" id="lbClose" title="閉じる">✕</button>
      <img id="lbImg" class="lb-img" alt="full-size" />
      <div class="lb-nav">
        <button class="lb-btn lb-prev" id="lbPrev" title="前へ">◀</button>
        <button class="lb-btn lb-next" id="lbNext" title="次へ">▶</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const els = {
      header: $('#hdr'), btnCollapse: $('#btnCollapse'),
      file: $('#file'), q: $('#q'), trust: $('#trustHtml'), stats: $('#stats'), tbody: $('#tbody'),
      btnCsvAll: $('#btnCsvAll'), btnCsvFiltered: $('#btnCsvFiltered'), btnHtmlAll: $('#btnHtmlAll'), btnHtmlFiltered: $('#btnHtmlFiltered'),
      expMsg: $('#expMsg'), dateFrom: $('#dateFrom'), dateTo: $('#dateTo'),
      btnPreset7d: $('#btnPreset7d'), btnPreset30d: $('#btnPreset30d'), btnPreset6m: $('#btnPreset6m'), btnPreset1y: $('#btnPreset1y'), btnClearDates: $('#btnClearDates'),
      enableWhitelist: $('#enableWhitelist'), whitelist: $('#whitelist'), linkSource: $('#linkSource'),
      lb: $('#lightbox'), lbImg: $('#lbImg'), lbClose: $('#lbClose'), lbPrev: $('#lbPrev'), lbNext: $('#lbNext'),
      btnPrintFiltered: $('#btnPrintFiltered'), theme: $('#theme'), density: $('#density'),
      feedUrl: $('#feedUrl'), autoLoad: $('#autoLoad'), btnFetchNow: $('#btnFetchNow'),
      btnFilePicker: $('#btnFilePicker'), fileNameStatus: $('#fileNameStatus')
    };

    const DEFAULT_FEED = 'https://si-auth.github.io/rss/auth0-changelog/rss.xml';
    const LS_KEY = 'auth0_rss_viewer_settings_v16';

    function saveSettings(){
      const obj = {
        trust: els.trust.checked,
        enableWhitelist: els.enableWhitelist.checked,
        whitelist: els.whitelist.value,
        linkSource: els.linkSource.value,
        q: els.q.value,
        dateFrom: els.dateFrom.value,
        dateTo: els.dateTo.value,
        collapsed: els.header.classList.contains('collapsed'),
        theme: els.theme?.value,
        density: els.density?.value,
        feedUrl: els.feedUrl?.value,
        autoLoad: !!els.autoLoad?.checked
      };
      localStorage.setItem(LS_KEY, JSON.stringify(obj));
    }
    function applyTheme(val){ const cls=['theme-auto','theme-light','theme-dark']; document.body.classList.remove(...cls); document.body.classList.add('theme-'+(val||'auto')); }
    function applyDensity(val){ const cls=['density-comfortable','density-compact']; document.body.classList.remove(...cls); document.body.classList.add('density-'+(val||'comfortable')); }
    function loadSettings(){
      try{
        const obj=JSON.parse(localStorage.getItem(LS_KEY)||'null');
        if(obj){
          els.trust.checked=!!obj.trust; els.enableWhitelist.checked=obj.enableWhitelist!==false; if(typeof obj.whitelist==='string') els.whitelist.value=obj.whitelist; if(obj.linkSource) els.linkSource.value=obj.linkSource; if(typeof obj.q==='string') els.q.value=obj.q; if(typeof obj.dateFrom==='string') els.dateFrom.value=obj.dateFrom; if(typeof obj.dateTo==='string') els.dateTo.value=obj.dateTo; if(obj.theme){ els.theme.value=obj.theme; applyTheme(obj.theme);} if(obj.density){ els.density.value=obj.density; applyDensity(obj.density);} if(typeof obj.feedUrl==='string'){ els.feedUrl.value=obj.feedUrl; } else { els.feedUrl.value = DEFAULT_FEED; } if(typeof obj.autoLoad==='boolean') els.autoLoad.checked=obj.autoLoad;
          if(obj.collapsed){ setCollapsed(true,false);} 
        } else {
          els.feedUrl.value = DEFAULT_FEED; els.autoLoad.checked = true;
        }
      }catch{ els.feedUrl.value = DEFAULT_FEED; }
    }

    // ===== Utilities =====
    const esc = (s='') => s.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[c]));
    function decodeHtmlEntitiesOnce(str=''){ const ta=document.createElement('textarea'); ta.innerHTML=str; return ta.value; }
    function decodeEntitiesDeep(str='', maxRounds=3){ let prev=str, cur=decodeHtmlEntitiesOnce(str), rounds=1; while(cur!==prev && rounds<maxRounds){ prev=cur; cur=decodeHtmlEntitiesOnce(prev); rounds++; } return cur; }

    function debounce(fn, ms=200){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=> fn(...args), ms); }; }

    function normHost(h){ return (h||'').trim().toLowerCase().replace(/^\*\./,'*.').replace(/^\.+/,''); }
    function parseWhitelist(){ const raw=(els.whitelist.value||'').split(/[\n,\s]+/).filter(Boolean).map(normHost); return raw; }
    function hostFromUrl(url){ try{ return new URL(url, location.origin).hostname.toLowerCase(); }catch{ return ''; } }
    function isAllowedUrl(url){ if(!els.enableWhitelist.checked) return true; const host=hostFromUrl(url); if(!host) return false; const wl=parseWhitelist(); if(wl.length===0) return false; return wl.some(p=>{ if(p.startsWith('*.')){ const base=p.slice(2); return host===base || host.endsWith('.'+base); } return host===p; }); }

    function isMalformedUrlAttr(val){ const v=(val||'').trim(); return v.startsWith('<a ') || /[<>]/.test(v); }

    function toHtmlFromPlain(text){ if(!text) return ''; let t=decodeEntitiesDeep(text);
      t=t.replace(/!\[([^\]]*)\]\(([^)\s]+)(?:\s+\"([^\"]+)\")?\)/g,(m,alt,url,title)=>{ if(!isAllowedUrl(url)||isMalformedUrlAttr(url)) return `<span class=\"blocked\" title=\"不正または許可外の画像URL\">[画像ブロック]</span>`; const a=esc(alt||''); const u=esc(url); const ti=title?` title=\"${esc(title)}\"`:''; return `<img src=\"${u}\" alt=\"${a}\" loading=\"lazy\" decoding=\"async\"${ti}>`; });
      t=t.replace(/\[([^\]]+)\]\(([^)\s]+)(?:\s+\"([^\"]+)\")?\)/g,(m,txt,url,title)=>{ if(!isAllowedUrl(url)||isMalformedUrlAttr(url)) return `<span class=\"blocked\" title=\"不正または許可外のリンク\">${esc(txt)}</span>`; const u=esc(url); const ti=title?` title=\"${esc(title)}\"`:''; return `<a href=\"${u}\" target=\"_blank\" rel=\"noopener noreferrer\"${ti}>${esc(txt)}</a>`; });
      t=t.replace(/(https?:\/\/[\w./#?=&%\-+,:;~!@()\[\]]+)/g,(m)=>{ if(!isAllowedUrl(m)||isMalformedUrlAttr(m)) return `<span class=\"blocked\" title=\"不正または許可外のリンク\">${esc(m)}</span>`; return `<a href=\"${esc(m)}\" target=\"_blank\" rel=\"noopener noreferrer\">${esc(m)}</a>`; });
      t=t.replace(/\n/g,'<br>'); return t; }

    function parseDate(s){ const d=new Date(s); const n=d.getTime(); return Number.isFinite(n)?n:0; }
    function pick(node, tag){ const el=node.querySelector(tag); if(!el) return ''; if(tag==='description') return el.innerHTML.trim(); return (el.textContent||'').trim(); }
    const pad2=n=>String(n).padStart(2,'0');
    function formatYYYYMMDD(ts, original){ if(Number.isFinite(ts)&&ts>0){ const d=new Date(ts); return `${d.getUTCFullYear()}/${pad2(d.getUTCMonth()+1)}/${pad2(d.getUTCDate())}`; } return original||''; }

    function sanitizeDescElement(root){
      root.querySelectorAll('script, iframe, object, embed, link, style').forEach(n=>n.remove());
      root.querySelectorAll('a[href]').forEach(a=>{ const href=a.getAttribute('href')||''; if(isMalformedUrlAttr(href)){ const span=document.createElement('span'); span.className='blocked'; span.title='不正なURL属性（HTML断片）'; span.textContent=a.textContent||href; a.replaceWith(span); return; } if(isAllowedUrl(href)){ a.target='_blank'; a.rel='noopener noreferrer'; } else { const host=hostFromUrl(href); const span=document.createElement('span'); span.className='blocked'; span.title=`ドメイン許可外: ${host}`; span.textContent=a.textContent||href; a.replaceWith(span);} });
      root.querySelectorAll('img[src]').forEach(img=>{ const src=img.getAttribute('src')||''; if(isMalformedUrlAttr(src)){ const span=document.createElement('span'); span.className='blocked'; span.title='不正な画像src（HTML断片）'; span.textContent='[画像ブロック]'; img.replaceWith(span); return; } if(isAllowedUrl(src)){ img.loading='lazy'; img.decoding='async'; img.style.cursor='zoom-in'; img.addEventListener('click', ()=>openLightbox(img.src)); } else { const host=hostFromUrl(src); const span=document.createElement('span'); span.className='blocked'; span.title=`ドメイン許可外: ${host}`; span.textContent='[画像ブロック]'; img.replaceWith(span);} });
    }

    function getLinkUrl(item){ if(els.linkSource.value==='link' && item.linkHref) return item.linkHref; return item.guid || item.linkHref || ''; }
    function descToPlainText(descRaw){ const div=document.createElement('div'); const looksHtml=/<\w+[^>]*>/.test(descRaw||''); div.innerHTML = looksHtml ? (descRaw||'') : toHtmlFromPlain(descRaw||''); return div.textContent || ''; }
    function highlightText(text, needle){ if(!needle) return esc(text||''); const safe=esc(text||''); try{ const re=new RegExp('('+needle.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','ig'); return safe.replace(re,'<mark class="h">$1</mark>'); }catch{ return safe; } }

    function buildRow(item){ const tr=document.createElement('tr'); const tdTitle=document.createElement('td'); tdTitle.className='col-title'; const tdDate=document.createElement('td'); tdDate.className='col-date'; const tdDesc=document.createElement('td'); const tdLink=document.createElement('td'); const q=(els.q.value||'').trim(); const titleBase=item.title||'(no title)'; const raw=decodeEntitiesDeep(item.description||''); const descPlain=descToPlainText(raw); tr.dataset.title=item.title||''; tr.dataset.desc=descPlain; tdTitle.innerHTML=`<strong>${highlightText(titleBase, q)}</strong>`;
      const kebabWrap=document.createElement('span'); kebabWrap.className='kebab-wrap'; const kebabBtn=document.createElement('button'); kebabBtn.type='button'; kebabBtn.className='kebab-btn'; kebabBtn.setAttribute('aria-haspopup','menu'); kebabBtn.setAttribute('aria-expanded','false'); kebabBtn.title='行アクション'; kebabBtn.textContent='⋯'; const menu=document.createElement('div'); menu.className='menu'; menu.setAttribute('role','menu'); menu.innerHTML=`\n        <button class=\"mi\" role=\"menuitem\" data-act=\"copy-title\"><span class=\"ico\">📋</span><span>題名をコピー (t)</span></button>\n        <button class=\"mi\" role=\"menuitem\" data-act=\"copy-desc\"><span class=\"ico\">📝</span><span>概要をコピー (d)</span></button>\n        <button class=\"mi\" role=\"menuitem\" data-act=\"search-g\"><span class=\"ico\">🔎</span><span>Google で検索 (g)</span></button>\n      `; kebabWrap.append(kebabBtn, menu); tdTitle.appendChild(kebabWrap);
      tdDate.textContent=formatYYYYMMDD(item._ts,item.pubDate); if(item.pubDate) tdDate.title=item.pubDate;
      const descDiv=document.createElement('div'); descDiv.className='desc'; if(els.trust.checked){ const looksHtml=/<\w+[^>]*>/.test(raw); descDiv.innerHTML=looksHtml?raw:toHtmlFromPlain(raw); sanitizeDescElement(descDiv); } else { const descText=raw; descDiv.innerHTML=highlightText(descText, q); } tdDesc.appendChild(descDiv);
      const href=getLinkUrl(item); if(href){ if(!isMalformedUrlAttr(href) && isAllowedUrl(href)){ const a=document.createElement('a'); a.href=href; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent=href; tdLink.appendChild(a);} else { const span=document.createElement('span'); span.className='blocked'; span.title=isMalformedUrlAttr(href)?'不正なリンクURL（HTML断片）':`ドメイン許可外: ${hostFromUrl(href)}`; span.textContent=href; tdLink.appendChild(span);} }
      kebabBtn.addEventListener('click',(e)=>{ e.stopPropagation(); closeAllMenus(); menu.classList.toggle('open'); const expanded=menu.classList.contains('open'); kebabBtn.setAttribute('aria-expanded', expanded?'true':'false'); });
      menu.addEventListener('click',(e)=>{ const btn=e.target.closest('[data-act]'); if(!btn) return; performAction(btn.dataset.act, tr); closeAllMenus(); });
      tr.append(tdTitle, tdDate, tdDesc, tdLink); return tr; }

    function closeAllMenus(){ $$('.menu.open').forEach(m=>{ m.classList.remove('open'); m.previousElementSibling?.setAttribute('aria-expanded','false'); }); }

    function copyText(text, okMsg){ if(!text){ els.expMsg.textContent='コピー対象がありません。'; return; } navigator.clipboard?.writeText(text).then(()=>{ els.expMsg.textContent=okMsg; setTimeout(()=>els.expMsg.textContent='',1500); }); }
    function performAction(act, row){ if(!row){ row=els.tbody.querySelector('tr'); } if(!row) return; if(act==='copy-title'){ copyText(row.dataset.title||'','タイトルをコピーしました。'); } else if(act==='copy-desc'){ copyText(row.dataset.desc||'','概要をコピーしました。'); } else if(act==='search-g'){ const title=row.dataset.title||''; const q=encodeURIComponent(title); window.open(`https://www.google.com/search?q=${q}`,'_blank','noopener'); } }

    function parseUTCBoundary(dateStr,end=false){ if(!dateStr) return null; const t=end?'T23:59:59.999Z':'T00:00:00.000Z'; const d=new Date(dateStr+t); const n=d.getTime(); return Number.isFinite(n)?n:null; }

    function filterItems(items){ const q=(els.q.value||'').toLowerCase(); const fromMs=parseUTCBoundary(els.dateFrom.value,false); const toMs=parseUTCBoundary(els.dateTo.value,true); const out=[]; for(const it of items){ if(q){ const hay=`${it.title}\n${it.description}`.toLowerCase(); if(!hay.includes(q)) continue; } if(fromMs!==null && it._ts<fromMs) continue; if(toMs!==null && it._ts>toMs) continue; out.push(it);} return out; }

    function render(items){ els.tbody.innerHTML=''; const filtered=filterItems(items); let count=0; const frag=document.createDocumentFragment(); for(const it of filtered){ frag.appendChild(buildRow(it)); count++; } els.tbody.appendChild(frag); els.stats.textContent=`${items.length.toLocaleString()}件 読込済み / フィルタ後 ${count.toLocaleString()}件`; if(count===0){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=4; td.style.color='var(--muted)'; td.style.padding='16px'; const q=(els.q.value||''); td.textContent=q?'条件に一致する項目がありません。':'データがありません。'; tr.appendChild(td); els.tbody.appendChild(tr);} saveSettings(); }

    function processXmlText(text){
      const xml=new DOMParser().parseFromString(text,'text/xml');
      const err=xml.querySelector('parsererror');
      if(err){ els.stats.textContent='XMLの解析に失敗しました。'; els.tbody.innerHTML=`<tr><td colspan=\"4\" style=\"color:var(--danger);padding:16px\">${esc(err.textContent)}</td></tr>`; return false; }
      let items=Array.from(xml.getElementsByTagName('item'));
      if(items.length===0) items=Array.from(xml.getElementsByTagName('entry'));
      const channelTitle=(xml.querySelector('channel>title')||xml.querySelector('feed>title'))?.textContent?.trim();
      const mapped=items.map(node=>{ const title=pick(node,'title'); const pubDate=pick(node,'pubDate')||pick(node,'updated')||pick(node,'published'); const description=pick(node,'description')||pick(node,'content')||pick(node,'summary'); let guid=pick(node,'guid'); let linkHref=''; const linkEl=node.querySelector('link[href]'); if(linkEl) linkHref=(linkEl.getAttribute('href')||'').trim(); if(!guid) guid=pick(node,'id'); return { title, pubDate, description, guid, linkHref, channelTitle, _ts: parseDate(pubDate) }; });
      mapped.sort((a,b)=>b._ts - a._ts); window.__ITEMS=mapped; window.__CHANNEL=channelTitle||'rss'; render(mapped); els.expMsg.textContent=''; return true;
    }

    async function fetchText(url, signal){ const res = await fetch(url, { signal, headers: { 'Accept': 'application/xml,text/xml;q=0.9,*/*;q=0.8' } }); if(!res.ok) throw new Error(`HTTP ${res.status}`); return await res.text(); }

    async function loadFromUrl(url){
      if(!url){ els.stats.textContent='URLが空です。'; return; }
      els.stats.textContent = 'ネットワークから取得中…';
      try{
        const controller=new AbortController();
        const timer=setTimeout(()=>controller.abort(), 20000);
        const text = await fetchText(url, controller.signal);
        clearTimeout(timer);
        if(!processXmlText(text)) return; 
        els.stats.textContent='取得完了';
      }catch(err){
        const msg=(err && err.name==='AbortError')? 'タイムアウト' : ((err && err.message) || String(err));
        els.stats.textContent = `取得に失敗しました: ${msg}`;
      }
    }

    function csvEscape(val){ if(val===null||val===undefined) return '""'; const s=String(val).replace(/\r\n|\r|\n/g,'\n').replace(/"/g,'""'); return '"'+s+'"'; }
    function toCsv(items){ const header=['title','pubDate','description','guid','channel']; const lines=[header.map(csvEscape).join(',')]; for(const it of items){ lines.push([csvEscape(it.title||''),csvEscape(it.pubDate||''),csvEscape(it.description||''),csvEscape(it.guid||''),csvEscape(it.channelTitle||'')].join(',')); } return lines.join('\r\n')+'\r\n'; }
    function timestampUTC(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+'_'+pad(d.getUTCHours())+pad(d.getUTCMinutes())+pad(d.getUTCSeconds())+'UTC'; }
    function downloadCsv(items, kind){ if(!items||!items.length){ els.expMsg.textContent='エクスポート対象がありません。'; return; } const csv=toCsv(items); const bom=new Uint8Array([0xEF,0xBB,0xBF]); const blob=new Blob([bom,csv],{type:'text/csv;charset=utf-8;'}); const ch=(window.__CHANNEL||'rss').replace(/[^\w\-]+/g,'_').slice(0,40)||'rss'; const fname=`${ch}_${kind}_${timestampUTC()}.csv`; const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fname; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); els.expMsg.innerHTML=`<span class=\"ok\">CSVを保存しました：</span> ${fname}`; }

    function sanitizeHtmlString(html){ const div=document.createElement('div'); div.innerHTML=html; sanitizeDescElement(div); return div.innerHTML; }
    function buildRowsHTML(items){ let html=''; const q=(els.q.value||'').trim(); for(const it of items){ const dateText=formatYYYYMMDD(it._ts,it.pubDate); const dateTitle=it.pubDate?` title=\"${esc(it.pubDate)}\"`:''; const raw=decodeEntitiesDeep(it.description||''); let descHtml=''; if(els.trust.checked){ const looksHtml=/<\w+[^>]*>/.test(raw); descHtml=sanitizeHtmlString(looksHtml? raw : toHtmlFromPlain(raw)); } else { descHtml=esc(raw); if(q){ const re=new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','ig'); descHtml = descHtml.replace(re,'<mark class=\"h\">$1</mark>'); } } const titleHtml = `<strong>${highlightText(it.title||'(no title)', q)}</strong>`; const href=(els.linkSource.value==='link' && it.linkHref)? it.linkHref : (it.guid||it.linkHref||''); let linkCell=''; if(href){ if(!isMalformedUrlAttr(href) && isAllowedUrl(href)){ linkCell=`<a href=\"${esc(href)}\" target=\"_blank\" rel=\"noopener noreferrer\">${esc(href)}</a>`; } else { linkCell=`<span class=\"blocked\" title=\"${isMalformedUrlAttr(href)?'不正なリンクURL（HTML断片）':('ドメイン許可外: '+esc(hostFromUrl(href)))}\">${esc(href)}</span>`; } } html += `\n<tr>\n  <td class=\"col-title\">${titleHtml}</td>\n  <td class=\"col-date\"${dateTitle}>${esc(dateText)}</td>\n  <td><div class=\"desc\">${descHtml}</div></td>\n  <td>${linkCell}</td>\n</tr>`; } return html; }
    function buildExportHTML(items, kind){ const ch=(window.__CHANNEL||'rss'); const q=(els.q.value||'').trim(); const df=els.dateFrom.value||''; const dt=els.dateTo.value||''; const gen=new Date(); const pad=n=>String(n).padStart(2,'0'); const genLocal=`${gen.getFullYear()}/${pad(gen.getMonth()+1)}/${pad(gen.getDate())} ${pad(gen.getHours())}:${pad(gen.getMinutes())}:${pad(gen.getSeconds())}`; const style=`:root{--bg:#f7f9fc;--card:#fff;--txt:#1e293b;--muted:#5b677a;--border:#d7e0ea;--hl:#fff1a6}
        body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif}
        .wrap{max-width:1200px;margin:0 auto;padding:16px}
        h1{margin:0 0 8px 0;font-size:1.05rem;color:#5b677a}
        .meta{color:#5b677a;font-size:.9rem;margin-bottom:12px}
        table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed;background:#fff;border:1px solid var(--border);border-radius:10px;overflow:hidden}
        thead th{position:sticky;top:0;background:#f9fbfe;border-bottom:1px solid var(--border);text-align:left;padding:10px;font-size:.9rem;color:#5b677a}
        tbody td{vertical-align:top;border-bottom:1px solid var(--border);padding:12px 10px;}
        tbody tr:nth-child(odd) td{background:#f6f9fe}
        col.c-title{width:16%} col.c-date{width:9%} col.c-desc{width:65%} col.c-link{width:10%}
        .col-title{min-width:200px}
        .col-date{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .desc{white-space:pre-wrap;word-wrap:break-word;overflow-wrap:anywhere}
        .desc img{max-width:100%;height:auto;border-radius:6px;border:1px solid #d7e0ea}
        .badge{display:none !important}
        mark.h{background:var(--hl);color:#222;padding:0 .15em;border-radius:3px}
        @page{size:A4;margin:15mm 12mm}
        @media print{ html,body{background:#fff;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact} a[href]::after{content:" (" attr(href) ")";font-size:.9em;color:#555} thead{display:table-header-group} tfoot{display:table-footer-group} tr, img{page-break-inside:avoid;break-inside:avoid} .desc{orphans:3;widows:3} }`;
      const rows=buildRowsHTML(items);
      return `<!DOCTYPE html>\n<html lang=\"ja\">\n<head>\n<meta charset=\"utf-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n<title>${esc(ch)} – 表エクスポート (${kind})</title>\n<style>${style}</style>\n</head>\n<body>\n<div class=\"wrap\">\n  <h1>${esc(ch)} – 表エクスポート (${kind})</h1>\n  <div class=\"meta\">生成: ${esc(genLocal)} / 条件: ${q?`キーワード=\"${esc(q)}\" `:''}${df||dt?`日付(UTC)=${esc(df||'')}${(df||dt)&&'〜'}${esc(dt||'')}`:''}</div>\n  <table>\n    <colgroup>\n      <col class=\"c-title\"><col class=\"c-date\"><col class=\"c-desc\"><col class=\"c-link\">\n    </colgroup>\n    <thead><tr><th>タイトル</th><th>日付</th><th>概要</th><th>リンク</th></tr></thead>\n    <tbody>${rows || '<tr><td colspan=4 style=\'color:#5b677a;padding:16px\'>データがありません。</td></tr>'}</tbody>\n  </table>\n</div>\n</body>\n</html>`; }
    function downloadHtml(items, kind){ if(!items||!items.length){ els.expMsg.textContent='エクスポート対象がありません。'; return; } const html=buildExportHTML(items, kind); const blob=new Blob([html],{type:'text/html;charset=utf-8;'}); const ch=(window.__CHANNEL||'rss').replace(/[^\w\-]+/g,'_').slice(0,40)||'rss'; const fname=`${ch}_table_${kind}_${timestampUTC()}.html`; const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fname; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); els.expMsg.innerHTML=`<span class=\"ok\">HTMLを保存しました：</span> ${fname}`; }

    function printFiltered(){
      const items = filterItems(window.__ITEMS||[]);
      if(!items.length){ els.expMsg.textContent='印刷対象がありません。'; return; }
      const html = buildExportHTML(items,'filtered');
      let w = null; try { w = window.open('', '_blank', 'noopener'); } catch {}
      if (w && typeof w.document !== 'undefined'){
        try { w.document.open(); w.document.write(html + '<script>window.onload=()=>{setTimeout(()=>{window.focus(); window.print();}, 50)}<\\/script>'); w.document.close(); return; } catch {}
      }
      const iframe=document.createElement('iframe');
      iframe.style.cssText='position:fixed;right:0;bottom:0;width:0;height:0;border:0';
      iframe.setAttribute('sandbox','allow-same-origin allow-modals allow-scripts');
      iframe.srcdoc = html + '<script>window.onload=()=>{setTimeout(()=>{window.focus(); window.print();}, 50)}<\\/script>';
      document.body.appendChild(iframe);
      setTimeout(()=>{ try{ document.body.removeChild(iframe); }catch{} }, 10000);
    }

    function setCollapsed(on, save=true){
      if(on){
        els.header.classList.add('collapsed');
        els.btnCollapse.setAttribute('aria-expanded','false');
        els.btnCollapse.innerHTML='<span class="ico">▼</span>コントロールをひらく';
      } else {
        els.header.classList.remove('collapsed');
        els.btnCollapse.setAttribute('aria-expanded','true');
        els.btnCollapse.innerHTML='<span class="ico">▲</span>コントロールをたたむ';
      }
      if(save) saveSettings();
    }
    els.btnCollapse.addEventListener('click', ()=>{ setCollapsed(!els.header.classList.contains('collapsed')); });

    document.addEventListener('click', (e)=>{ const t=e.target; if(!t.closest('.kebab-wrap')) closeAllMenus(); if(t===els.lb){ closeLightbox(); } });

    // ===== ファイル読み込み =====
    function handleFile(f){ if(!f) return; const r=new FileReader(); r.onload=()=>{ processXmlText(r.result); els.stats.textContent='ファイルから読込み完了'; }; r.onerror=()=>{ els.stats.textContent='ファイル読み込みに失敗しました。'; }; r.readAsText(f, 'utf-8'); if(els.fileNameStatus){ els.fileNameStatus.textContent = 'ローカルXML: ' + (f.name || '未選択'); } }
    els.file.addEventListener('change', ()=> handleFile(els.file.files[0]));
    els.btnFilePicker?.addEventListener('click', ()=>{ els.file?.click(); });

    // ===== Lightbox =====
    let currentImages=[]; let currentIndex=-1; let lastFocusedEl=null;
    function collectImages(){ currentImages = $$('.desc img').map(img=>img.src); }
    function openLightbox(src){ lastFocusedEl=document.activeElement; collectImages(); currentIndex=currentImages.indexOf(src); if(currentIndex<0){ currentImages.push(src); currentIndex=currentImages.length-1; } els.lbImg.src=src; els.lb.classList.add('open'); els.lb.setAttribute('aria-hidden','false'); els.lb.setAttribute('aria-modal','true'); els.lb.setAttribute('tabindex','-1'); els.lb.focus({preventScroll:true}); document.body.style.overflow='hidden'; }
    function closeLightbox(){ els.lb.classList.remove('open'); els.lb.setAttribute('aria-hidden','true'); els.lbImg.src=''; document.body.style.overflow=''; if(lastFocusedEl?.focus) lastFocusedEl.focus(); }
    function showPrev(){ if(currentImages.length<2) return; currentIndex=(currentIndex-1+currentImages.length)%currentImages.length; els.lbImg.src=currentImages[currentIndex]; }
    function showNext(){ if(currentImages.length<2) return; currentIndex=(currentIndex+1)%currentImages.length; els.lbImg.src=currentImages[currentIndex]; }

    // ===== init & bindings =====
    function bindReRender(id, ev='change'){ const el=els[id]; if(!el) return; el.addEventListener(ev, ()=> window.__ITEMS && render(window.__ITEMS)); }

    loadSettings();

    const renderDebounced = debounce(()=> window.__ITEMS && render(window.__ITEMS), 200);
    els.q.addEventListener('input', renderDebounced);

    bindReRender('trust'); bindReRender('enableWhitelist'); bindReRender('whitelist','input'); bindReRender('linkSource'); bindReRender('dateFrom'); bindReRender('dateTo');

    $('#btnPreset7d').addEventListener('click', (e)=>{ e.preventDefault(); const now=new Date(); const to=new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())); const from=new Date(to.getTime()); from.setUTCDate(from.getUTCDate()-(7-1)); els.dateFrom.value=`${from.getUTCFullYear()}-${String(from.getUTCMonth()+1).padStart(2,'0')}-${String(from.getUTCDate()).padStart(2,'0')}`; els.dateTo.value=`${to.getUTCFullYear()}-${String(to.getUTCMonth()+1).padStart(2,'0')}-${String(to.getUTCDate()).padStart(2,'0')}`; render(window.__ITEMS||[]); });
    $('#btnPreset30d').addEventListener('click', (e)=>{ e.preventDefault(); const now=new Date(); const to=new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())); const from=new Date(to.getTime()); from.setUTCDate(from.getUTCDate()-(30-1)); els.dateFrom.value=`${from.getUTCFullYear()}-${String(from.getUTCMonth()+1).padStart(2,'0')}-${String(from.getUTCDate()).padStart(2,'0')}`; els.dateTo.value=`${to.getUTCFullYear()}-${String(to.getUTCMonth()+1).padStart(2,'0')}-${String(to.getUTCDate()).padStart(2,'0')}`; render(window.__ITEMS||[]); });
    $('#btnPreset6m').addEventListener('click', (e)=>{ e.preventDefault(); const now=new Date(); const to=new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())); const from=new Date(to.getTime()); from.setUTCMonth(from.getUTCMonth()-6); els.dateFrom.value=`${from.getUTCFullYear()}-${String(from.getUTCMonth()+1).padStart(2,'0')}-${String(from.getUTCDate()).padStart(2,'0')}`; els.dateTo.value=`${to.getUTCFullYear()}-${String(to.getUTCMonth()+1).padStart(2,'0')}-${String(to.getUTCDate())}-${''}`; render(window.__ITEMS||[]); });
    $('#btnPreset1y').addEventListener('click', (e)=>{ e.preventDefault(); const now=new Date(); const to=new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())); const from=new Date(to.getTime()); from.setUTCFullYear(from.getUTCFullYear()-1); els.dateFrom.value=`${from.getUTCFullYear()}-${String(from.getUTCMonth()+1).padStart(2,'0')}-${String(from.getUTCDate()).padStart(2,'0')}`; els.dateTo.value=`${to.getUTCFullYear()}-${String(to.getUTCMonth()+1).padStart(2,'0')}-${String(to.getUTCDate()).padStart(2,'0')}`; render(window.__ITEMS||[]); });
    $('#btnClearDates').addEventListener('click', (e)=>{ e.preventDefault(); els.dateFrom.value=''; els.dateTo.value=''; render(window.__ITEMS||[]); });

    els.btnCsvAll?.addEventListener('click', ()=>{ if(window.__ITEMS) downloadCsv(window.__ITEMS,'all'); });
    els.btnCsvFiltered?.addEventListener('click', ()=>{ if(window.__ITEMS) downloadCsv(filterItems(window.__ITEMS),'filtered'); });
    els.btnHtmlAll?.addEventListener('click', ()=>{ if(window.__ITEMS) downloadHtml(window.__ITEMS,'all'); });
    els.btnHtmlFiltered?.addEventListener('click', ()=>{ if(window.__ITEMS) downloadHtml(filterItems(window.__ITEMS),'filtered'); });

    els.btnPrintFiltered?.addEventListener('click', ()=>{ if(window.__ITEMS) printFiltered(); });

    els.theme?.addEventListener('change', ()=>{ applyTheme(els.theme.value); saveSettings(); });
    els.density?.addEventListener('change', ()=>{ applyDensity(els.density.value); saveSettings(); });

    els.btnFetchNow?.addEventListener('click', ()=> loadFromUrl(els.feedUrl.value));

    ['trust','enableWhitelist','whitelist','linkSource','dateFrom','dateTo','theme','density','feedUrl','autoLoad']
      .forEach(id=>{ const el=els[id]; if(!el) return; const ev=(id==='whitelist'||id==='feedUrl')?'input':'change'; el.addEventListener(ev, saveSettings); });

    if(els.autoLoad?.checked){ loadFromUrl(els.feedUrl.value); }
  </script>
</body>
</html>
